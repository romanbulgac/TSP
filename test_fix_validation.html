<!DOCTYPE html>
<html>
<head>
    <title>TSP Fix Validation Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; }
        .results { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 10px 0; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; font-family: monospace; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>TSP Tour.Clone() Fix Validation Test</h1>
        <p>This test validates that the genetic algorithm returns non-zero fitness values after the Tour.Clone() fix.</p>
        
        <button id="testButton" onclick="runTest()">Run Test</button>
        
        <div class="results">
            <h3>Test Results:</h3>
            <div id="testResults">Click "Run Test" to start...</div>
        </div>
        
        <div class="log">
            <h3>Detailed Log:</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        let connection;
        let testResults = [];
        let isTestRunning = false;

        async function initializeSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("http://localhost:5001/tspHub")
                .build();

            connection.on("ReceiveGAResult", function (result) {
                logMessage(`Received result: Generation ${result.generation}, Best Fitness: ${result.bestFitness}, Best Distance: ${result.bestDistance}`);
                
                // Store results for analysis
                testResults.push({
                    generation: result.generation,
                    bestFitness: result.bestFitness,
                    bestDistance: result.bestDistance
                });
                
                // Update UI with current best
                if (result.bestFitness && result.bestFitness > 0) {
                    document.getElementById('testResults').innerHTML = 
                        `<span class="success">‚úÖ SUCCESS: Receiving non-zero fitness values!</span><br>` +
                        `Current Best Fitness: ${result.bestFitness}<br>` +
                        `Current Best Distance: ${result.bestDistance}<br>` +
                        `Generation: ${result.generation}`;
                } else if (result.bestFitness === 0) {
                    document.getElementById('testResults').innerHTML = 
                        `<span class="error">‚ùå PROBLEM: Received zero fitness value!</span><br>` +
                        `Generation: ${result.generation}`;
                }
            });

            await connection.start();
            logMessage("‚úÖ SignalR connection established");
        }

        async function runTest() {
            if (isTestRunning) return;
            
            isTestRunning = true;
            testResults = [];
            document.getElementById('testButton').disabled = true;
            document.getElementById('testResults').innerHTML = '<span class="info">üîÑ Running test...</span>';
            document.getElementById('log').innerHTML = '';
            
            try {
                // Initialize SignalR if not already connected
                if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                    await initializeSignalR();
                }

                // Generate random cities
                logMessage("üîÑ Generating random cities...");
                const citiesResponse = await fetch('http://localhost:5001/api/tsp/cities/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count: 10 })
                });
                
                const cities = await citiesResponse.json();
                logMessage(`‚úÖ Generated ${cities.length} cities`);

                // Start TSP solving
                logMessage("üîÑ Starting TSP genetic algorithm...");
                const solveResponse = await fetch('http://localhost:5001/api/tsp/solve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cities: cities,
                        config: {
                            populationSize: 30,
                            generations: 50,
                            mutationRate: 0.01,
                            crossoverType: "OrderCrossover",
                            mutationType: "SwapMutation"
                        }
                    })
                });

                const result = await solveResponse.json();
                logMessage(`‚úÖ TSP solving completed: ${result.message}`);
                
                // Wait a moment for all results to come in
                setTimeout(() => {
                    analyzeResults();
                }, 2000);

            } catch (error) {
                logMessage(`‚ùå ERROR: ${error.message}`);
                document.getElementById('testResults').innerHTML = 
                    `<span class="error">‚ùå Test failed: ${error.message}</span>`;
            } finally {
                document.getElementById('testButton').disabled = false;
                isTestRunning = false;
            }
        }

        function analyzeResults() {
            if (testResults.length === 0) {
                document.getElementById('testResults').innerHTML = 
                    '<span class="error">‚ùå No results received - there might be a connection issue</span>';
                return;
            }

            const nonZeroFitnessResults = testResults.filter(r => r.bestFitness && r.bestFitness > 0);
            const zeroFitnessResults = testResults.filter(r => r.bestFitness === 0);
            
            logMessage(`üìä Analysis: ${testResults.length} total results, ${nonZeroFitnessResults.length} with non-zero fitness, ${zeroFitnessResults.length} with zero fitness`);
            
            if (nonZeroFitnessResults.length > 0 && zeroFitnessResults.length === 0) {
                document.getElementById('testResults').innerHTML = 
                    `<span class="success">‚úÖ SUCCESS: Tour.Clone() fix is working!</span><br>` +
                    `All ${nonZeroFitnessResults.length} results had non-zero fitness values.<br>` +
                    `Best fitness achieved: ${Math.max(...nonZeroFitnessResults.map(r => r.bestFitness))}<br>` +
                    `Best distance achieved: ${Math.min(...nonZeroFitnessResults.map(r => r.bestDistance))}`;
            } else if (zeroFitnessResults.length > 0) {
                document.getElementById('testResults').innerHTML = 
                    `<span class="error">‚ùå PARTIAL ISSUE: Some results still have zero fitness</span><br>` +
                    `Non-zero fitness results: ${nonZeroFitnessResults.length}<br>` +
                    `Zero fitness results: ${zeroFitnessResults.length}`;
            } else {
                document.getElementById('testResults').innerHTML = 
                    '<span class="error">‚ùå ISSUE: All results have zero fitness - the fix may not be working</span>';
            }
        }

        function logMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Initialize on load
        window.addEventListener('load', function() {
            logMessage("üöÄ TSP Fix Validation Test initialized");
        });
    </script>
</body>
</html>
